\section{Проектирование системы плагина захвата движений}

Проектирование плагина захвата движений предполагает разработку в несколько этапов:
\begin{itemize}
	\item изучение доступных средств Blender
	\item выбор библиотек компьютерного зрения
	\item создание объекта с которым будет взаимодействовать плагин
	\item определение алгоритмов, по которым будет работать плагин
	\item написание и отладка плагина
\end{itemize}

Целью выпускной квалификационной бакалаврской работы является разработка плагина захвата движений для записи лицевой анимации в реальном времени внутри пакета Blender, целью практической работы является изучение доступных средств Blender3D и проектирование структуры плагина.

\subsection{Изучение доступных средств Blender}

Кроме стандартных для трехмерных графических пакетов функций, в Blender стандартно поставляется текстовый редактор и интерпретатор языка Python 3 \cite{blenderprogbook}.

Главной частью выполнения скриптов является модуль bpy, позволяющий любое действие, которое можно было бы произвести при помощи интерфейса, выполнить программно.

\subsection{Интерфейс}
Интерфейс для скриптинга (рис. \ref{scriptinterf}) состоит из:
\begin{itemize}
	\item текстового редактора
	\item интерактивной консоли
	\item лога команд
\end{itemize}
\addimghere{scriptinginterface}{1}{Интерфейс панели скриптинга}{scriptinterf}

Текстовый редактор позволяет создавать и редактировать как скрипты на языке python, так и любые другие текстовые файлы

Интерактивная консоль представляет собой окружение, схожее с интерактивной консолью python. Консоль никак не связана с кодом, запускаемым из текстового редактора, но и консоль, и редактор имеют полный доступ к глобальным данным Blender, содержащимся в модуле bpy и его подмодулях.

Лог команд показывает, какие вызовы были сделаны интерфейсом программы во время использования. Просмотр вывода этого окна сильно упрощает изучение API и эксперименты с ним.

\subsubsection{Модуль BPY}

Главным модулем в Blender является bpy \cite{blenderapiref}. Данный модуль позволяет взаимодействовать со всеми данными Blender, его классами и функциями. 

Подмодуль bpy.ops содержит операторы. Операторы это основные функции для взаимодействия с объектами, подобно тому как художник в Blender манипулирует объектами через интерфейс.
Два самых важных класса в этом модуле -  bpy.ops.object и bpy.ops.mesh. Класс object содержит функции для управления объектами в целом, а также общие функции. Класс mesh содержит непосредственно функции для редактирования точек, граней, фейсов, обычно в режиме Edit Mode.

Подмодуль bpy.context используется для доступа к объектам и областям Blender по различным их статусам.

Подмодуль bpy.data даёт доступ к внтренним данным Blender. Так например  bpy.data.objects содержит все данные, определяющие форму объекта и его положение в пространчтве.

Подмодуль bpy.props содержит как стадартные свойства (типы данных), которые можно использовать в Blender, так и даёт возможность определять свои собственные.

Подмодуль bpy.utils содержит функции Blender, не связанные с его объектами и данными, как например функции для загрузки модулей и регистрирования их в системе.

\subsection{Проектирование структуры плагина}

Представляемый пайплайн работы системы представлен на рис. \ref{pipe}. Плагин должен захватывать поток с вебкамеры, обрабатывать его с помощью библиотек компьютерного зрения и по полученным данным управлять мимикой модели в сцене.

\addimghere{pipeline}{0.7}{Пайплайн системы анимирования в реальном времени}{pipe}

Видеопоток с камеры подается в ПК, где с помощью библиотеки OpenCV перехватывается и разбивается на кадры. В каждом из кадров натренированный каскад определения опорных точек библиотеки DLib пытается определить опорные точки на лице в кадре. Если точки найдены, то включается в работу основной алгоритм программы.

Первая часть алгоритма с помощью функций линейной математики пакета OpenCV и точек на лице, найденных в DLib определяет положение головы, вторая часть определяет расстояние между точками на лице, чтобы вычислить коэффициент положения точек относительно друг друга. Найденное положение головы управляет движением головы модели вверх, вниз и вокруг своей оси. По значениям же коэффициентов с помощью API Blender будут передвигаться выбранные кости.

Для удобства плагин должен состоять из двух файлов - файла, добавляющего пользовательский интерфейс и файла оператора, вызываемого и настраиваемого через кнопки интерфейса. Планируется, что оператор будет работать по таймеру или через функцию handlers, встроенную в Blender.

Интерфейс для удобства его использования должен находиться в N-меню рядом с интерфейсом данных об объекте.

Версия Blender, под которую создаётся плагин должна быть не менее версии 2.8 или новее, что позволит использовать последние наработки и возможности Blender.

Операционная система любая, удовлетворяющая условиям запуска пакета Blender и установки библиотек OpenCV и DLib.

\clearpage
